<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>â™»ï¸ Geri DÃ¶nÃ¼ÅŸÃ¼m SÄ±nÄ±flandÄ±rÄ±cÄ±</title>
  <style>
    :root{ --primary:#2ecc71; --bg:#f8f9fa; --text:#333; --warn:#f39c12; --danger:#e74c3c; }
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial;background:var(--bg);color:#333;margin:0;display:flex;flex-direction:column;align-items:center}
    header{width:100%;padding:12px 16px;text-align:center;color:#fff;background:var(--primary);font-weight:600;letter-spacing:.2px}
    main{width:100%;max-width:820px;padding:16px}
    #cam-container{width:100%;max-width:520px;margin:16px auto;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.08);background:#000}
    video,canvas{width:100%;display:block;border-radius:12px}
    video{min-width:320px;min-height:240px;background:#000}
    .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    button{padding:12px;border:none;border-radius:10px;cursor:pointer;font-weight:600;background:#fff;color:#333;box-shadow:0 1px 4px rgba(0,0,0,.06);transition:transform .06s ease, box-shadow .2s ease;flex:1 1 46%;max-width:260px}
    button:hover{box-shadow:0 3px 10px rgba(0,0,0,.12)}
    button:active{transform:scale(.98)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-warn{background:var(--warn);color:#111}
    .btn-danger{background:var(--danger);color:#fff}
    .card{margin:16px auto;width:100%;max-width:620px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    #result-label{font-size:1.6rem;font-weight:800;margin-top:6px}
    #confidence{color:#666;margin-top:4px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.9rem;font-weight:700;background:#eef3ee;color:#2e7d32}
    #loader{display:none}
    progress{width:100%;height:12px;border-radius:999px}
    .muted{color:#777;font-size:.95rem}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.9rem}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>
</head>
<body>
  <header>â™»ï¸ Geri DÃ¶nÃ¼ÅŸÃ¼m SÄ±nÄ±flandÄ±rÄ±cÄ±</header>
  <main>
    <div id="cam-container"><video id="cam" autoplay playsinline muted></video></div>

    <div class="row">
      <button class="btn-primary" id="btnSnap">ğŸ“¸ FotoÄŸraf Ã‡ek &amp; Tahmin</button>
      <button class="btn-warn" id="btnClear">ğŸ”„ Sonucu Temizle</button>
      <button class="btn-danger" id="btnReset">ğŸ—‘ï¸ TÃ¼m Ã–rnekleri SÄ±fÄ±rla</button>
    </div>

    <div class="card" id="loader">
      <div class="pill">Otomatik EÄŸitim</div>
      <div style="margin:10px 0 6px">Manifest: <span class="mono" id="dsPath">dataset.json</span></div>
      <progress id="pbar" max="100" value="0"></progress>
      <div class="muted" id="ptext">HazÄ±rlanÄ±yorâ€¦</div>
    </div>

    <div class="row" style="margin-top:10px">
      <button onclick="addExample('plastik')">Plastik Ã¶rnek ekle</button>
      <button onclick="addExample('kagit')">KÃ¢ÄŸÄ±t Ã¶rnek ekle</button>
      <button onclick="addExample('cam')">Cam Ã¶rnek ekle</button>
      <button onclick="addExample('metal')">Metal Ã¶rnek ekle</button>
    </div>

    <div id="result" class="card" style="display:none;text-align:center">
      <div><span class="pill">Tahmin</span></div>
      <div id="result-label">â€”</div>
      <div id="confidence">GÃ¼ven: â€”</div>
      <div id="hint" class="muted" style="margin-top:8px"></div>
    </div>
  </main>

<script>
const DATASET_PATH = 'dataset.json';
const CONF_THRESHOLD = 0.60;

let net, classifier;
const camEl = document.getElementById('cam');
const resultCard = document.getElementById('result');
const resultLabel = document.getElementById('result-label');
const confidenceEl = document.getElementById('confidence');
const hintEl = document.getElementById('hint');
const loaderCard = document.getElementById('loader');
const pbar = document.getElementById('pbar');
const ptext = document.getElementById('ptext');
const dsPathEl = document.getElementById('dsPath');

async function setupCam(){
  const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'}, audio:false });
  camEl.srcObject = stream;
  await new Promise(r=> camEl.onloadedmetadata = r);
}
async function init(){
  await setupCam();
  classifier = knnClassifier.create();
  net = await mobilenet.load({ version:2, alpha:1.0 });
  console.log('âœ… MobileNet yÃ¼klendi.');
}
function captureTensor(){
  const c=document.createElement('canvas');
  c.width = camEl.videoWidth||320; c.height = camEl.videoHeight||240;
  c.getContext('2d').drawImage(camEl,0,0,c.width,c.height);
  return tf.browser.fromPixels(c);
}
async function addExample(label){
  const img=captureTensor(); const act=net.infer(img,'conv_preds');
  classifier.addExample(act,label); img.dispose(); act.dispose?.();
}
async function predict(){
  if (classifier.getNumClasses()===0){ alert('Ã–nce verisetinden ya da butonlardan Ã¶rnek ekleyin.'); return null; }
  const img=captureTensor(); const act=net.infer(img,'conv_preds');
  const res=await classifier.predictClass(act,3); img.dispose(); act.dispose?.(); return res;
}
async function captureAndPredict(){
  const res=await predict(); if(!res) return;
  const label=res.label; const conf=res.confidences[label]??0;
  if (conf<CONF_THRESHOLD){ showResult('Emin deÄŸilim', conf); hintEl.textContent='Objeyi merkeze alÄ±n, biraz yaklaÅŸtÄ±rÄ±n ve tekrar deneyin.'; return; }
  showResult(prettyLabel(label),conf); hintEl.textContent=tipFor(label);
}
function showResult(label,conf){
  resultCard.style.display='block';
  resultLabel.textContent=label;
  confidenceEl.textContent=isNaN(conf)?'GÃ¼ven: â€”':('GÃ¼ven: '+(conf*100).toFixed(1)+'%');
}
function resetResult(){ resultCard.style.display='none'; resultLabel.textContent='â€”'; confidenceEl.textContent='GÃ¼ven: â€”'; hintEl.textContent=''; }
function prettyLabel(l){ const m={plastik:'Plastik',kagit:'KÃ¢ÄŸÄ±t',cam:'Cam',metal:'Metal','emin-degilim':'Emin deÄŸilim'}; return m[l]||l; }
function tipFor(l){ const t={plastik:'Åeffaf/renkli plastiklerde parlamayÄ± azaltmak iÃ§in Ä±ÅŸÄ±k aÃ§Ä±sÄ±nÄ± deÄŸiÅŸtirin.',kagit:'YazÄ±/doku belirginse sonuÃ§ iyileÅŸir. Arka planÄ± sade tutun.',cam:'Cam yansÄ±malarÄ± karÄ±ÅŸtÄ±rabilir; kamerayÄ± hafif aÃ§Ä±yla tutun.',metal:'Metal yÃ¼zeylerde parlama olabilir; objeyi biraz uzaklaÅŸtÄ±rÄ±n.'}; return t[l]||''; }
function toast(m){ console.log(m); }

function loadImageAsTensor(url){
  return new Promise((resolve,reject)=>{
    const img=new Image(); img.crossOrigin='anonymous';
    img.onload=()=> resolve(tf.browser.fromPixels(img));
    img.onerror=()=> reject(new Error('Ä°ndirilemedi: '+url));
    img.src=url;
  });
}
async function loadTrainingSet(path=DATASET_PATH){
  dsPathEl.textContent=path; loaderCard.style.display='block';
  let manifest;
  try{
    const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw new Error('Manifest indirilemedi: '+r.status);
    manifest=await r.json();
  }catch(e){ ptext.textContent='Manifest okunamadÄ±: '+e.message; console.error(e); return; }

  const entries=Object.entries(manifest);
  const total=entries.reduce((a,[,u])=>a+u.length,0)||1; let done=0;
  for (const [label,urls] of entries){
    for (const url of urls){
      try{ const img=await loadImageAsTensor(url); const act=net.infer(img,'conv_preds'); classifier.addExample(act,label); img.dispose(); act.dispose?.(); }
      catch(e){ console.warn('AtlandÄ±:',url,e.message); }
      done++; const pct=Math.round((done/total)*100); pbar.value=pct; ptext.textContent=`YÃ¼kleniyor: ${done}/${total} (${pct}%) â€“ sÄ±nÄ±f: ${label}`;
      if (done%25===0) await tf.nextFrame();
    }
  }
  loaderCard.style.display='none';
  console.log(`âœ… Otomatik eÄŸitim tamamlandÄ±. Toplam Ã¶rnek: ${done}`);
}

document.getElementById('btnSnap').onclick=captureAndPredict;
document.getElementById('btnClear').onclick=resetResult;
document.getElementById('btnReset').onclick=()=>{ classifier=knnClassifier.create(); resetResult(); loaderCard.style.display='none'; toast('TÃ¼m Ã¶rnekler sÄ±fÄ±rlandÄ±.'); };

(async()=>{ await init(); await loadTrainingSet(DATASET_PATH); })();
</script>

<script>
  
  
  async function loadTrainingSet(url){
    const res = await fetch(url);
    const dataset = await res.json();
    let total = dataset.length;
    let done = 0;
  
    for (const {url:imgUrl,label} of dataset){
      try {
        const img = await loadImage(imgUrl);
        const act = net.infer(img,'conv_preds');
        classifier.addExample(act,label);
        img.dispose();
      } catch(e){ console.warn('AtlandÄ±', imgUrl); }
      done++;
    }
    console.log(`âœ… Otomatik eÄŸitim tamamlandÄ±. Toplam Ã¶rnek: ${done}`);
  }
  
  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = ()=>resolve(tf.browser.fromPixels(img));
      img.onerror = reject;
      img.src = url;
    });
  }
  
  // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda otomatik eÄŸitim
  (async()=>{
    await init();
    await loadTrainingSet(DATASET_PATH);
  })();
  </script>
  
</body>
</html>
